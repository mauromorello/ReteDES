<?php

include_once ("../rend.php");

if (is_logged_in($user)){
		$cookie_read = explode("|", base64_decode($user));
		$id_user = $cookie_read[0];
		$username =$cookie_read[1];
		$gas = id_gas_user($id_user);
		$gas_name = gas_nome($gas);
		$permission = (int)$cookie_read[6];
		$my_level = user_level($id_user);
		
	  if(!($permission & perm::puo_postare_messaggi)){
			$q = "not_allowed";
			include ("../index.php");
			exit;  		  
	 }
	 
	 if($my_level<5){
		 if($id_user<>proprietario_messaggio_bacheca($id)){
			$q = "not_allowed";
			include ("../index.php");
			exit;  
		 }
	 } 
	  //echo "Do : $do<br>";
	  //echo "Id : $id<br>";
	  //echo "Data 1  : $data_1<br>";
	  //echo "Data 2  : $data_2<br>";
	  //echo "Data 3  : $data_3<br>";
	  //echo "Data 4  : $data_4<br>";
	  //echo "Data 5  : $data_5<br>";
	  //echo "Data 6  : $data_6<br>";
	 
	 // Controlli sui dati --------------------------------- CCCC
	  if(!isset($id)){
		  pussa_via();
		  exit;
	  }else{
		$data_1 = $id;
	  }
	  
	  if ($do=="mod"){
	  //echo "DATA =$data_3<br>";

		  
	  $data_3 = (int)$data_3;
	  if($data_3<0){$data_3=0;}
	  if($data_3>4){$data_3=4;}
	  
	  $data_4 = (int)$data_4;
	  if($data_4<0){$data_4=0;}
	  
	  
	  if (empty($data_2)){$msg.="Titolo obbligatorio<br>";$e_empty++;};
	  //if (empty($data_3)){$msg.="Visibilità obbligatoria<br>";$e_empty++;};
	  //if (empty($data_4)){$msg.="Argomento obbligatorio<br>";$e_empty++;};
	  if (empty($data_6)){$msg.="Il messaggio deve contenere qualcosa<br>";$e_empty++;}; 
	  
	  if (gas_mktime($data_5)<gas_mktime(date("d/m/Y"))){
		 $msg.="Data scadenza già passata";
		 $e_date++; 
	  }

	  
	  
	  
	  //Echo "Puro data_6 = $data_6<br>";
	  
	   
	  
	  //$data_6 = base64_encode($data_6);
	  
	  $msg.="<br>Verifica i dati immessi e riprova";
	  
	  
	  $e_total = $e_empty + $e_logical + $e_numerical + $e_date;
	  
	  if($e_total==0){
		  
		 $data_2 = sanitize($data_2); 
		 $data_5 = conv_date_to_db($data_5);
		 $data_6 = sanitize($data_6); 
		//echo "ZERO ERRORI !!!";
		
		//echo "Data 2 = $data_2<br>";
		//echo "Data 3 = $data_3<br>";
		//echo "Data 4 = $data_4<br>";
		//echo "Data 5 = $data_5<br>";
		//echo "Data 6 = $data_6<br>";
		
		
		
		// QUERY INSERT
		$my_query=  "UPDATE retegas_bacheca 
					SET 
					id_utente = '$id_user',
					visibility = '$data_3',
					code_uno = '$data_4',
					titolo_messaggio = '$data_2',
					scadenza = '$data_5',
					messaggio = '$data_6'
					WHERE id_bacheca = '$data_1' LIMIT 1;";
		
		//INSERT BEGIN ---------------------------------------------------------
		 $result = $db->sql_query($my_query);
		 //echo "query = $my_query<br>";
		 //echo "result = $result";
		 
		 if (empty($result)){
			$msg = "Errore nell'inserimento del record";
			//include ("../index.php");
			exit;  
		}else{
			$msg = "Messaggio Modificato";
			include("bacheca_table.php");
			exit;  
		};
		
		//INSERT END --------------------------------------------------------- 
		
		
		
		 
		  
	  }else{
		  
		  
		  
		  
		  
		include_once("bacheca_form_edit.php");  
		  
		  
	  } // se non ci sono errori
	  
	  } // Se do = mod
	  

	   

	  
	  
	  $query = "SELECT * FROM retegas_bacheca WHERE id_bacheca='$data_1';";
	  $res = $db->sql_query($query);
	  $row = $db->sql_fetchrow($res);
	  
	  if(!isset($data_2)){$data_2=$row["titolo_messaggio"];}  //Titolo
	  if(!isset($data_3)){$data_3=$row["visibility"];}  //Visibilità 
	  if(!isset($data_4)){$data_4=$row["code_uno"];}  //Argomento 
	  if(!isset($data_5)){$data_5=conv_only_date_from_db($row["scadenza"]);}  //Scadenza
	  if(!isset($data_6)){$data_6=$row["messaggio"];}  //Argomento	  
	  
	  // MENU APERTO
	  $menu_aperto=2;
	  
					  
	  // TITOLO FORM_ADD
	  $titolo_tabella="Edita il messaggio della bacheca";
	  
	  $col_2=" style=\"text-align:left;\" ";

					
	  
		  
	  // FORM -------------------------------------------
	  
	 $title_form = "<form name=\"Aggiungi Messaggio\" method=\"POST\" action=\"bacheca_form_edit.php\" style=\"margin-top:10px;\">";
	 $submit_form ="<input class = \"large awesome\" style=\"margin:20px;\" type=\"submit\" value=\"Salva le modifiche\">";  
	  
	  // Campi
	  
	  $input_2 = "<input type=\"text\" name=\"data_2\" size=\"70\" value=\"$data_2\" style=\"font-size:1.4em\">";
	  
	  
	  // LISTA ARGOMENTI
	  $input_3 = "<fieldset style=\"border:0\"><select name= \"data_3\">";
		//$input_4 .= "<option value=\"0\" SELECTED >Selezionare argomento messaggio</option>";
			while (list($chiave,$valore) = each($RG_visibility_messaggi)){
				if((int)$chiave==$data_3){$sel = " SELECTED ";}else{$sel = "";}; 
				$input_3.= "<option value=\"".$chiave."\" $sel>".$valore ."  </option>";
			}
	  $input_3 .="</select>
				  </fieldset>";
	  unset($chiave);
	  unset($valore);
	  unset($sel);
	  
	  // LISTA ARGOMENTI
	  $input_4 = "<fieldset style=\"border:0\"><select name= \"data_4\">";
		
		while (list($chiave,$valore) = each($RG_lista_argomenti_messaggi)){
			if($chiave==$data_4){$sel = " SELECTED ";}else{$sel = "";};	 
			$input_4.= "<option value=\"".$chiave ."\" $sel>".$valore ."  </option>";
			}
	  $input_4 .="</select></fieldset>";
	  
	  $input_5 = "<input id=\"datepicker\" type=\"text\" name=\"data_5\" size=\"15\" value=\"$data_5\">";
	  $input_6 = "<textarea class =\"ckeditor\" name=\"data_6\" cols=\"28\">$data_6</textarea>";
	  $input_hidden = "<input type=\"hidden\" name=\"do\" size=\"28\" value=\"mod\">";
	  $input_hidden_2 = "<input type=\"hidden\" name=\"id\" size=\"28\" value=\"$data_1\">";
	  

	  
	  
	  
	  
	  // COSTRUZIONE TABELLA  -----------------------------------------------------------------------
	  
	  //$h_table .= ditte_menu_1();
	  
	  include("bacheca_menu_core.php");
	  
	  $h_table .= "	<div class=\"ui-widget-content padding-6px ui-corner-all\">
					<h3><center> 
					$titolo_tabella
					</center>
					</h3>
					
					
					
					
					$title_form
					<table>
					 
					";
	 
	 $h_table .=  "
					<tr class=\"odd\">
						<th $col_1>Titolo</th>
						<td $col_2>$input_2</td>
					</tr>
					<tr class=\"odd\">
						<th $col_1>Visibilità</th>
						<td $col_2>$input_3</td>
					</tr>
					<tr class=\"odd\">
						<th $col_1>Argomento</th>
						<td $col_2>$input_4</td>
					</tr>
					<tr class=\"odd\">
						<th $col_1>Scadenza</th>
						<td $col_2>$input_5</td>
					</tr>
					<tr class=\"odd\">
						<th $col_1>Messaggio</th>
						<td $col_2>$input_6 $input_hidden $input_hidden_2</td>
					</tr>
					<tr>
						<th $col_1>&nbsp</th>
						<td $col_2>$submit_form </td>
					</tr>
					
					 
					</table>
					
					
					</form> 
					</div>
					
					";

	  // END TABELLA ----------------------------------------------------------------------------
	  
	  // HEADER HTML
	  $posizione ="<b>Modifica un messaggio alla bachecona</b>";
	  
	  $is_ckeditor = "SI";
	  $datepickers = "SI";
	  $datepickers_name_1 = "datepicker";
	  $qtip_on = "SI";
	  
	  include ("bacheca_main.php");
 
}else{
	c1_go_away("?q=no_permission");
} 
?>
