<?php

include_once ("../rend.php");

if (is_logged_in($user)){
		$cookie_read = explode("|", base64_decode($user));
		$id_user = $cookie_read[0];
		$username =$cookie_read[1];
		$gas = id_gas_user($id_user);
		$gas_name = gas_nome($gas);
	  
	  
		$permission = $cookie_read[6];
		//controllo se posso
if(($permission & perm::puo_eliminare_messaggi)){
	if($do=="del"){
		$id=(int)$id;
		$que = "DELETE FROM retegas_bacheca WHERE id_bacheca='$id' LIMIT 1";      
		$result= $db->sql_query($que);
		$msg = "Post cancellato";		
	}
}	  
	  
	  
	  
	  // MENU APERTO
	  $menu_aperto=2;
	  
	  // TITOLO TABELLA
	  $titolo_tabella="Bacheca :";
	  
	 
	 if(!isset($id_visi)){$filter_visi="";}else{$filter_visi="retegas_bacheca.visibility='$id_visi' ";$ti=$RG_visibility_messaggi["$id_visi"];}
	 if(!isset($id_argo)){$filter_argo="";}else{$filter_argo="retegas_bacheca.code_uno='$id_argo' ";$to=$RG_lista_argomenti_messaggi["$id_argo"];}  
	 
	 if (!empty($filter_visi)){
	 $fi = " WHERE ";    
	 }
	 if (!empty($filter_argo)){
	 $fi = " WHERE ";    
	 } 
	 if (!empty($filter_visi)){
		 $fi .= $filter_visi." ";
		 if (!empty($filter_argo)){
			$fi .= " AND $filter_argo ";
		 }            
	 }else{
		 if (!empty($filter_argo)){
			$fi .= $filter_argo." ";
		 }
		 
	 }
	  
	  // QUERY
	  $my_query="SELECT retegas_bacheca.*
				FROM retegas_bacheca
				$fi
				ORDER BY
				timbro_bacheca DESC;";
	 //echo $my_query; 

	  
	  // COSTRUZIONE TABELLA  -----------------------------------------------------------------------
	  global $db;

	  $result = $db->sql_query($my_query);
	  $lista = bacheca_array_quantita_messaggi();
	  
	  while (list($chiave,$valore) = each($RG_lista_argomenti_messaggi)){
		  if($lista[$chiave]>0){
			if(isset($id_visi)){$id_vis="id_visi=$id_visi";}else{$id_vis="";}
			$url_filter = $RG_addr["bacheca"].'?'.$id_vis.'&id_argo='.$chiave;  
			$lista_argomenti .= "<a href=\"$url_filter\">$valore</a> <span class=\"small_link\">( ".$lista[$chiave]." )</span><br>";
			 }      
		}
	 
	  
	  include("bacheca_menu_core.php"); 	
	  
	  if(!empty($to)){$to = "'".$to."'";}
		  
	  $h_table .='<div class="rg_widget rg_widget_helper">
				  <h3>Bacheca messaggi : '.$to.' visibili  '.$ti.' </h3>
				  <table>
				  <tr>
				  <td width="20%" style="text-align:left;">
				  <b>ARGOMENTI :</b><br><hr />
				  '.$lista_argomenti.'
				  </td>
				  <td>';
	  
		 while ($row = mysql_fetch_array($result)){
		 
			  $c1 = $row["id_bacheca"];
			  $c2 = $row["titolo_messaggio"];
			  $c6 = substr(strip_tags($row["messaggio"]),0,50)." ...";
			  $c4 = $RG_lista_argomenti_messaggi[$row["code_uno"]];
			  $c9 = conv_datetime_from_db($row["timbro_bacheca"]);
			  $c8 = fullname_from_id($row["id_utente"]);
			  $c7 = conv_date_from_db($row["scadenza"]);
			  $c5 = $RG_visibility_messaggi[$row["visibility"]];
			  
			  $c11 = gas_nome(id_gas_user($row["id_utente"]));
			  
			  
			  unset ($op1);
			  unset ($op2);
			  unset ($op3);
			  
			  $op3 = '<a rel="'.$c1.'" class="awesome small green display_full_message" style="margin:4px;">I</a>';
			
			  
			  if($id_user==$row["id_utente"]){
				  $op1 ='<a class="awesome black small" title="Cancella" href="bacheca_table.php?do=del&id='.$c1.'" style="margin:4px;">C</a>';
				  $op2 ='<a class="awesome yellow small" title="Modifica" href="bacheca_form_edit.php?id='.$c1.'" style="margin:4px;">M</a>'; 
			  }
			  
			  $permission = $cookie_read[6];
			  //controllo se posso
			  if(($permission & perm::puo_eliminare_messaggi)){
				  $op1 ='<a class="awesome black small" title="Elimina" href="bacheca_table.php?do=del&id='.$c1.'" style="margin:4px;">E</a>';          
			  }
			  
			  
			  
			  
			  $is_visible= true;
			  $color_vi = "#C8F7F7";
			  
			  if($row["visibility"]==1){$is_visible= true;$color_vi = "#F7D3C8";}
			  if($row["visibility"]==2){
				 
				  if(id_gas_user($row["id_utente"])==$gas){$is_visible= true;$color_vi = "#F4F48A";}else{$is_visible= false;$color_vi = "#969696";}
			  }
			  if($row["visibility"]==3){ 
				  if($row["id_utente"]==$id_user){$is_visible= true;$color_vi = "#F4CAF4";}else{$is_visible= false;$color_vi = "#969696";}
			  }
			  
			  
			  if(user_level($id_user)==5){$is_visible= true;
			  
			  }
		
		$color_visibility = "background-image:-webkit-gradient(linear,0 0,0 100,from($color_vi),to(#DDDDDD));";      
				  
		if($is_visible){				  
		$h_table .= '<div class="ui-widget ui-corner-all padding-6px" style="'.$color_visibility.'">
					<table>
					<tr>
					<td width="10%" class="argomento_messaggio">
					'.$c4.'
					</td>
					<td  style="text-align:left;">
					<div class="small_link">
					Il '.$c9.', '.$c8.' ('.$c11.') ha scritto questo messaggio visibile da <b>'.$c5.'</b> e valido fino al '.$c7.'
					</div>
					<a href="bacheca_form.php?id='.$c1.'"><b>'.$c2.'</b></a><br>
					'.$c6.'
					</td> 
					<td width="15%"  style="text-align:left;">
					<div>'.$op1.$op2.$op3.'</div>
					</td>
					</tr>	
					</table>
					</div>
					<br>';
		}// is visible		
			  
		 }//end while

	  $h_table .='</td>
	  </tr>
	  </table>
	  </div>
	  ';	 
		 
	  // END TABELLA ----------------------------------------------------------------------------
	  $posizione ="<b>Tutta la bachecona</b>";
	  $qtip_on="TRUE";
	  $qtip_ajax="bacheca_form_messaggio.php";
	  
	  include ("bacheca_main.php");
	  
	  
	  
}else{
	c1_go_away("?q=no_permission");
} 
?>
