<?php

function read_option_integer($id_user,$chiave){

    global $db;
    $qry = "SELECT * FROM retegas_options 
            WHERE
            id_user = '$id_user'
            AND
            chiave = '$chiave'
            LIMIT 1;";
   $res = $db->sql_query($qry);
   $row = $db->sql_fetchrow($res);
   
   return CAST_TO_INT($row["valore_int"]);         
            
    
}
function read_option_text($id_user,$chiave){

    global $db;
    $qry = "SELECT * FROM retegas_options 
            WHERE
            id_user = '$id_user'
            AND
            chiave = '$chiave'
            LIMIT 1;";
   $res = $db->sql_query($qry);
   $row = $db->sql_fetchrow($res);
   
   return CAST_TO_STRING($row["valore_text"]);         
            
    
}
function read_option_gas_text($id_gas,$chiave){

    global $db;
    $qry = "SELECT * FROM retegas_options 
            WHERE
            valore_int = '$id_gas'
            AND
            id_user='0'
            AND
            chiave = '$chiave'
            LIMIT 1;";
   $res = $db->sql_query($qry);
   $row = $db->sql_fetchrow($res);
   
   return CAST_TO_STRING($row["valore_text"]);         
            
    
}
function read_option_decimal($id_user,$chiave){

    global $db;
    $qry = "SELECT * FROM retegas_options 
            WHERE
            id_user = '$id_user'
            AND
            chiave = '$chiave'
            LIMIT 1;";
   $res = $db->sql_query($qry);
   $row = $db->sql_fetchrow($res);
   
   return CAST_TO_FLOAT($row["valore_real"]);         
            
    
}
function read_option_note($id_user,$chiave){

    global $db;
    $qry = "SELECT * FROM retegas_options 
            WHERE
            id_user = '$id_user'
            AND
            chiave = '$chiave'
            LIMIT 1;";
   $res = $db->sql_query($qry);
   $row = $db->sql_fetchrow($res);
   
   return ($row["note_1"]);         
            
    
}

function check_option_exist($id_user,$chiave){

    global $db;
    $qry = "SELECT * FROM retegas_options 
            WHERE
            id_user = '$id_user'
            AND
            chiave = '$chiave';";
   $res = $db->sql_query($qry);
   $row = $db->sql_numrows($res);
   
   return $row;         
            
    
}
function check_option_gas_exist($id_gas,$chiave){

    global $db;
    $qry = "SELECT * FROM retegas_options 
            WHERE
            id_user = '0'
            AND
            valore_int='$id_gas'
            AND
            chiave = '$chiave';";
   $res = $db->sql_query($qry);
   $row = $db->sql_numrows($res);
   
   return $row;         
            
    
}



function write_option_integer($id_user,$chiave,$valore){
    
    global $db;
    
    $valore = CAST_TO_INT($valore);
    
    if(check_option_exist($id_user,$chiave)==0){
            $qry = "INSERT INTO  
                    `my_retegas`.`retegas_options` (
                        `id_option` ,
                        `id_user` ,
                        `chiave` ,
                        `valore_text` ,
                        `timbro` ,
                        `valore_int` ,
                        `valore_real` ,
                        `note_1`
                        )
                    VALUES (
                             NULL ,  
                             '$id_user',  
                             '$chiave',  
                             '', 
                             CURRENT_TIMESTAMP,  
                             '$valore', 
                             NULL ,  
                             ''
                    );";    
    }else{
        $qry = "UPDATE  `my_retegas`.`retegas_options` 
                SET  `valore_int` =  '$valore' 
                WHERE  
                id_user = '$id_user'
                AND
                chiave = '$chiave' 
                LIMIT 1 ;";
        
    }
    
    
   $res = $db->sql_query($qry);
   $rows = $db->sql_affectedrows($res);
   
   return $row;         
            
    
}
function write_option_text($id_user,$chiave,$valore){
    
    global $db;
    
    $id_user = CAST_TO_INT($id_user);
    $valore = CAST_TO_STRING($valore);
    
    if(check_option_exist($id_user,$chiave)==0){
            $qry = "INSERT INTO  
                    `my_retegas`.`retegas_options` (
                        `id_option` ,
                        `id_user` ,
                        `chiave` ,
                        `valore_text` ,
                        `timbro` ,
                        `valore_int` ,
                        `valore_real` ,
                        `note_1`
                        )
                    VALUES (
                             NULL ,  
                             '$id_user',  
                             '$chiave',  
                             '$valore', 
                             CURRENT_TIMESTAMP,  
                             '', 
                             NULL ,  
                             ''
                    );";    
    }else{
        $qry = "UPDATE  `my_retegas`.`retegas_options` 
                SET  `valore_text` =  '$valore' 
                WHERE  
                id_user = '$id_user'
                AND
                chiave = '$chiave' 
                LIMIT 1 ;";
        
    }
    
    
   $res = $db->sql_query($qry);
   $rows = $db->sql_affectedrows($res);
   
   return $rows;         
            
    
}
function write_option_note($id_user,$chiave,$valore){
    
    global $db;
    
    $id_user = CAST_TO_INT($id_user);
    $valore = sanitize($valore);
    
    if(check_option_exist($id_user,$chiave)==0){
            $qry = "INSERT INTO  
                    `my_retegas`.`retegas_options` (
                        `id_option` ,
                        `id_user` ,
                        `chiave` ,
                        `valore_text` ,
                        `timbro` ,
                        `valore_int` ,
                        `valore_real` ,
                        `note_1`
                        )
                    VALUES (
                             NULL ,  
                             '$id_user',  
                             '$chiave',  
                             null, 
                             CURRENT_TIMESTAMP,  
                             '', 
                             NULL ,  
                             '$valore'
                    );";    
    }else{
        $qry = "UPDATE  `my_retegas`.`retegas_options` 
                SET  `note_1` =  '$valore' 
                WHERE  
                id_user = '$id_user'
                AND
                chiave = '$chiave' 
                LIMIT 1 ;";
        
    }
    
    
   $res = $db->sql_query($qry);
   $rows = $db->sql_affectedrows($res);
   
   return $rows;         
            
    
}

function write_option_gas_text($id_gas,$chiave,$valore){
    
    global $db;
    
    $id_gas = CAST_TO_INT($id_gas);
    $valore = CAST_TO_STRING($valore);
    
    if(check_option_gas_exist($id_gas,$chiave)==0){
            $qry = "INSERT INTO  
                    `my_retegas`.`retegas_options` (
                        `id_option` ,
                        `id_user` ,
                        
                        `chiave` ,
                        `valore_text` ,
                        `timbro` ,
                        `valore_int` ,
                        `valore_real` ,
                        `note_1`
                        )
                    VALUES (
                             NULL ,  
                             '0',
                               
                             '$chiave',  
                             '$valore', 
                             CURRENT_TIMESTAMP,  
                             '$id_gas', 
                             NULL ,  
                             ''
                    );";    
    }else{
        $qry = "UPDATE  `my_retegas`.`retegas_options` 
                SET  `valore_text` =  '$valore' 
                WHERE  
                id_user = '0'
                AND
                valore_int = '$id_gas'
                AND
                chiave = '$chiave' 
                LIMIT 1 ;";
        
    }
    
    
   $res = $db->sql_query($qry);
   $rows = $db->sql_affectedrows($res);
   
   return $rows;         
            
    
}
function write_option_decimal($id_user,$chiave,$valore){
    
    global $db;
    
    $valore = CAST_TO_FLOAT($valore);
    
    if(check_option_exist($id_user,$chiave)==0){
            $qry = "INSERT INTO  
                    `my_retegas`.`retegas_options` (
                        `id_option` ,
                        `id_user` ,
                        `chiave` ,
                        `valore_text` ,
                        `timbro` ,
                        `valore_int` ,
                        `valore_real` ,
                        `note_1`
                        )
                    VALUES (
                             NULL ,  
                             '$id_user',  
                             '$chiave',  
                             '', 
                             CURRENT_TIMESTAMP,  
                             '', 
                             $valore ,  
                             ''
                    );";    
    }else{
        $qry = "UPDATE  `my_retegas`.`retegas_options` 
                SET  `valore_text` =  '$valore' 
                WHERE  
                id_user = '$id_user'
                AND
                chiave = '$chiave' 
                LIMIT 1 ;";
        
    }
    
    
   $res = $db->sql_query($qry);
   $rows = $db->sql_affectedrows($res);
   
   return $row;         
            
    
}


function delete_option_text($id_user,$chiave){
    global $db;
    $qry = "DELETE FROM retegas_options 
            WHERE
            id_user = '$id_user'
            AND
            chiave = '$chiave';";
   $res = $db->sql_query($qry);
       
}


function load_user_options($id_user){
    global $db;
    $qry = "SELECT * FROM retegas_options 
            WHERE
            id_user = '$id_user'
            OR
            (id_user='0'
            AND
            valore_int='"._USER_ID_GAS."');";
   $res = $db->sql_query($qry);
   while ($row = mysql_fetch_array($res)){
        //echo $row["chiave"]." --> ".$row["valore_text"]."<br>";
        switch ($row["chiave"]){
          case"MSG";
            define("_USER_HAVE_MSG",true);
            define("_USER_MSG",$row["valore_text"]);
            //delete_option_text($id_user,"MSG");
          break;
          case"LANG";
            define("_USER_LANGUAGE",$row["valore_text"]);
          break;
          case"_USER_OPT_SEND_MAIL";
            define("_USER_OPT_SEND_MAIL",$row["valore_text"]);
          break;
          case"_USER_OPT_NO_HEADER";
            define("_USER_OPT_NO_HEADER",$row["valore_text"]);
          break;
          case"_USER_OPT_SHOW_DEBUG";
            define("_USER_OPT_SHOW_DEBUG",CAST_TO_INT($row["valore_int"]));
            break;
          case"_USER_OPT_NO_SITE_HEADER";
            define("_USER_OPT_NO_SITE_HEADER",$row["valore_text"]);
          break;
          case"_USER_OPT_THEME";
            define("_USER_OPT_THEME",$row["valore_text"]);
          break;
          case"_USER_OPT_DECIMALS";
            define("_USER_OPT_DECIMALS",CAST_TO_INT($row["valore_int"],1,4));
          break;
          case"_USER_USA_CASSA";
            if($row["valore_text"]=="SI"){
                define("_USER_USA_CASSA",true);    
            }else{
                define("_USER_USA_CASSA",false);
            }  
          break;
          case"_USER_USA_TOOLTIPS";
            if($row["valore_text"]=="SI"){
                define("_USER_USA_TOOLTIPS",true);    
            }else{
                define("_USER_USA_TOOLTIPS",false);
            }  
          break;
          //CSV
          case"_USER_CSV_SEPARATOR";
            define("_USER_CSV_SEPARATOR",CAST_TO_STRING($row["valore_text"],1));
          break;
          case"_USER_CSV_DELIMITER";
            define("_USER_CSV_DELIMITER",CAST_TO_STRING($row["valore_text"],1));
          break;
          case"_USER_CSV_EOL";
            if($row["valore_text"]=="n"){
                define("_USER_CSV_EOL","\n");    
            }
            if($row["valore_text"]=="rn"){
                define("_USER_CSV_EOL","\r\n");
            }
          break;
          case"_USER_CSV_ZERO";
            if($row["valore_text"]=="0"){
                define("_USER_CSV_ZERO",0);    
            }else{
                define("_USER_CSV_ZERO","");
            }
          break;
          
          
          
          
          case"_USER_CARATTERE_DECIMALE";
            if($row["valore_text"]=="."){
                define("_USER_CARATTERE_DECIMALE",".");    
            }else{
                define("_USER_CARATTERE_DECIMALE",",");
            }  
          break;
          
          case"_GAS_SITE_LOGO";
            define("_GAS_SITE_LOGO",($row["valore_text"]));
          break;
          
          case"_GAS_USA_CASSA";
          if($row["valore_text"]=="SI"){
                define("_GAS_USA_CASSA",true);    
            }else{
                define("_GAS_USA_CASSA",false);
            }
          break;
          
          case"_GAS_PUO_PART_ORD_EST";
          if($row["valore_text"]=="SI"){
                define("_GAS_PUO_PART_ORD_EST",true);    
            }else{
                define("_GAS_PUO_PART_ORD_EST",false);
            }
          break;
          
          case"_GAS_PUO_COND_ORD_EST";
          if($row["valore_text"]=="SI"){
                define("_GAS_PUO_COND_ORD_EST",true);    
            }else{
                define("_GAS_PUO_COND_ORD_EST",false);
            }
          break;
          
          case"_GAS_COPERTURA_CASSA";
          if(CAST_TO_INT($row["valore_text"],0,100)>0){
                define("_GAS_COPERTURA_CASSA",CAST_TO_INT($row["valore_text"],0,100));    
            }else{
                define("_GAS_COPERTURA_CASSA",0);
            }
          break;
          
          case"_GAS_CASSA_MIN_LEVEL";
          if(CAST_TO_FLOAT($row["valore_text"],0,1000)>0){
                define("_GAS_CASSA_MIN_LEVEL",CAST_TO_FLOAT($row["valore_text"],0,1000));    
            }else{
                define("_GAS_CASSA_MIN_LEVEL",0);
            }
          break;
                       
        }
   }
   if(!defined("_USER_HAVE_MSG")){define("_USER_HAVE_MSG",false);}
   if(!defined("_USER_MSG")){define("_USER_MSG",false);}
   if(!defined("_USER_OPT_NO_HEADER")){define("_USER_OPT_NO_HEADER","NO");}
   if(!defined("_USER_OPT_THEME")){define("_USER_OPT_THEME",false);}
   if(!defined("_USER_OPT_NO_SITE_HEADER")){define("_USER_OPT_NO_SITE_HEADER","NO");}
   if(!defined("_USER_LANGUAGE")){define("_USER_LANGUAGE","NON DEFINITA");}
   if(!defined("_USER_OPT_SEND_MAIL")){define("_USER_OPT_SEND_MAIL","SI");}
   if(!defined("_USER_OPT_SHOW_DEBUG")){define("_USER_OPT_SHOW_DEBUG",0);}
   if(!defined("_USER_OPT_DECIMALS")){define("_USER_OPT_DECIMALS",2);}
   if(!defined("_USER_USA_CASSA")){define("_USER_USA_CASSA",false);}
   if(!defined("_USER_USA_TOOLTIPS")){define("_USER_USA_CASSA",true);}
   if(!defined("_USER_CARATTERE_DECIMALE")){define("_USER_CARATTERE_DECIMALE",".");}
   //CSV
   if(!defined("_USER_CSV_DELIMITER")){define("_USER_CSV_DELIMITER",'"');}
   if(!defined("_USER_CSV_SEPARATOR")){define("_USER_CSV_SEPARATOR",',');}
   if(!defined("_USER_CSV_EOL")){define("_USER_CSV_EOL","\r\n");}
   if(!defined("_USER_CSV_ZERO")){define("_USER_CSV_ZERO",0);}
   
   //GAS
   if(!defined("_GAS_USA_CASSA")){define("_GAS_USA_CASSA",false);}
   if(!defined("_GAS_PUO_PART_ORD_EST")){define("_GAS_PUO_PART_ORD_EST",false);}
   if(!defined("_GAS_PUO_COND_ORD_EST")){define("_GAS_PUO_COND_ORD_EST",false);}
   if(!defined("_GAS_SITE_LOGO")){define("_GAS_SITE_LOGO","");}    
   if(!defined("_GAS_COPERTURA_CASSA")){define("_GAS_COPERTURA_CASSA",0);}
   if(!defined("_GAS_CASSA_MIN_LEVEL")){define("_GAS_CASSA_MIN_LEVEL",0);} 
}
  
?>