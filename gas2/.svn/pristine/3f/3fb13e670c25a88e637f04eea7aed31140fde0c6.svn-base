<?php
   
// immette i file che contengono il motore del programma
include_once ("../../rend.php");
include_once ("../../retegas.class.php");
include_once ("../ordini_renderer.php");

// controlla se l'user ha effettuato il login oppure no
if (!_USER_LOGGED_IN){
     pussa_via(); 
}    

!isset($limit) ? $limit=40 : $limit=CAST_TO_INT($limit,0,500);

//Creazione della nuova pagina uso un oggetto rg_simplest
$r = new rg_simplest();
//Dico quale voce del menù verticale dovrà essere aperta
$r->voce_mv_attiva = 2;
//Assegno il titolo che compare nella barra delle info
$r->title = "Ordini chiusi";


//Messaggio popup;
//$r->messaggio = "Pagina di test"; 
//Dico quale menù orizzontale dovrà  essere associato alla pagina.
$id_ordine = null;
$r->menu_orizzontale[] = ordini_menu_visualizza($user,$id_ordine);


//Assegno le due tabelle a tablesorter
$r->javascripts[]=java_tablesorter("output_1");


$r->messaggio = $msg;
//Creo la pagina dell'aggiunta


$query = "SELECT * FROM retegas_ordini WHERE data_chiusura < NOW() ORDER BY data_chiusura DESC;";
$res = $db->sql_query($query);

$h .= "<div class=\"rg_widget rg_widget_helper\">";
$h .= "<h3>Ordini chiusi</h3>";
$h .= "<form method=\"POST\" action=\"\">Mostra al massimo <input type=\"text\" size=\"10\" name=\"limit\" value=\"$limit\">ordini. <input type=\"submit\" value=\"aggiorna\"></form>";
$h .= "<table id=\"output_1\">";
$h .= "<thead>";
    $h .="<tr>";
    $h .="<th>Stato</td>";
    $h .="<th>ID</td>";
    $h .="<th>Descrizione</td>";
    $h .="<th>Ditta</td>";
    $h .="<th>Proposto</td>";
    $h .="<th>Data Chiusura</td>";
    //$h .="<th>Importo totale</td>";
    $h .="<th>Mia Spesa</td>";
    $h .="</tr>";
$h .= "</thead>";
$h .= "<tbody>";
while ($row = mysql_fetch_array($res)){
    if($ord > ($limit-1)){break;};
    if(gas_partecipa_ordine($row["id_ordini"],_USER_ID_GAS)>0){
        $ord++;
        
        $row["is_printable"] ? $pal=pallino("grigio",16): $pal=pallino("rosso",16);
        
        //$vto = valore_totale_lordo_ordine($row["id_ordini"]);
        $vmo = valore_totale_mio_ordine_lordo($row["id_ordini"],_USER_ID);
        
        $t_vto = $t_vto + $vto;
        $t_vmo = $t_vmo + $vmo;
        
        $h .="<tr>";
        $h .="<td>$pal</td>";
        $h .="<td><a href=\"".$RG_addr["ordini_form"]."?id_ordine=".$row["id_ordini"]."\">".$row["id_ordini"]."</a></td>";
        $h .="<td><a href=\"".$RG_addr["ordini_form"]."?id_ordine=".$row["id_ordini"]."\">".($row["descrizione_ordini"])."</a></td>";
        $h .="<td>".ditta_nome_from_listino($row["id_listini"])."</td>";
        $h .="<td>".gas_nome(id_gas_user(id_referente_ordine_globale($row["id_ordini"])))."</td>";
        $h .="<td>".conv_datetime_from_db($row["data_chiusura"])."</td>";
        //$h .="<td>".round($vto,2)."</td>";
        $h .="<td>".round($vmo,2)."</td>";
        $h .="</tr>";
    }
}
$h .="</tbody>";
$h .= "<tfoot>";
    $h .="<tr>";
    $h .="<th>&nbsp</td>";
    $h .="<th>&nbsp</td>";
    $h .="<th>Totali</td>";
    $h .="<th>&nbsp</td>";
    $h .="<th>&nbsp</td>";
    $h .="<th>&nbsp</td>";
    //$h .="<th>".round($t_vto,2)."</td>";
    $h .="<th>".round($t_vmo,2)."</td>";
    $h .="</tr>";
$h .= "</tfoot>";
$h .="</table>";
$h .="</div><br>";

//Questo è¨ il contenuto della pagina
$r->contenuto = $h;

//Mando all'utente la sua pagina
echo $r->create_retegas();
//Distruggo l'oggetto r    
unset($r)   
?>